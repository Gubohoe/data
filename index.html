<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Korea Population Estimates (2022)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.min.js"></script>
</head>
<body>
    <div id="main" style="width: 800px; height: 600px;"></div>

    <div>
        <label for="csvData">CSV 데이터 입력:</label>
        <textarea id="csvData" rows="5" cols="40"></textarea>
        <button id="submitData">데이터 시각화</button>
    </div>

    <script>
        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom);
        var option;

        document.getElementById('submitData').addEventListener('click', function () {
            myChart.showLoading();

            // CSV 데이터 입력을 가져오기
            var csvData = document.getElementById('csvData').value;

            // CSV 데이터를 JSON으로 파싱
            var csvRows = csvData.split('\n');
            var keys = csvRows[0].split(',');
            var jsonData = [];
            for (var i = 1; i < csvRows.length; i++) {
                var values = csvRows[i].split(',');
                var obj = {};
                for (var j = 0; j < keys.length; j++) {
                    obj[keys[j]] = values[j];
                }
                jsonData.push(obj);
            }

            // JSON 데이터로 변환
            var jsonStr = JSON.stringify(jsonData);

            // ECharts로 데이터 시각화
            renderECharts(jsonStr);
        });

        function renderECharts(jsonData) {
            // JSON 데이터를 파싱하여 JavaScript 객체로 변환
            var data = JSON.parse(jsonData);

            // 지도 데이터 로드
            var koreaMapURL = 'korea.json';

            fetch(koreaMapURL)
                .then(function (response) {
                    return response.json();
                })
                .then(function (koreaJson) {
                    myChart.hideLoading();
                    echarts.registerMap('Korea', koreaJson);

                    option = {
                        title: {
                            text: 'Korea Population Estimates (2022)',
                            subtext: 'Data source: Your Source',
                            sublink: 'https://yourdatasource.com',
                            left: 'right'
                        },
                        tooltip: {
                            trigger: 'item',
                            showDelay: 0,
                            transitionDuration: 0.2
                        },
                        visualMap: {
                            left: 'right',
                            min: 0,
                            max: getMaxValue(data),  // 최대 값은 사용자 제공 데이터 중 최댓값으로 설정
                            inRange: {
                                color: [
                                    '#f9f0a6',
                                    '#ecaa61',
                                    '#e2765a',
                                    '#c94c4c',
                                    '#882426'
                                ]
                            },
                            text: ['High', 'Low'],
                            calculable: true
                        },
                        toolbox: {
                            show: true,
                            left: 'left',
                            top: 'top',
                            feature: {
                                dataView: { readOnly: false },
                                restore: {},
                                saveAsImage: {}
                            }
                        },
                        series: [
                            {
                                name: 'Korea PopEstimates',
                                type: 'map',
                                roam: true,
                                map: 'Korea',
                                emphasis: {
                                    label: {
                                        show: true
                                    }
                                },
                                data: data
                            }
                        ]
                    };

                    myChart.setOption(option);
                })
                .catch(function (error) {
                    console.error('Failed to load Korea map data:', error);
                });
        }

        // 사용자 제공 데이터 중 최댓값을 찾는 함수
        function getMaxValue(data) {
            var maxValue = 0;
            for (var i = 0; i < data.length; i++) {
                var value = parseInt(data[i].value);
                if (!isNaN(value) && value > maxValue) {
                    maxValue = value;
                }
            }
            return maxValue;
        }
    </script>
</body>
</html>
